---
import Layout from '../../../../layouts/Layout.astro';
import plugins from '../../../../data/plugins.json';
import { PluginDetail } from '../../../../components/PluginDetail';
import fs from 'fs';
import path from 'path';

export function getStaticPaths() {
  const paths = [];
  const countries = ['all', 'venezuela', 'argentina'];
  
  for (const plugin of plugins) {
    for (const platform of plugin.platform) {
      for (const country of countries) {
        // Verificar si el plugin está disponible para este país
        const isAvailable = country === 'all' ? true : plugin.countries.includes(country);
        const isExcluded = plugin.countrie_exclude?.includes(country);
        
        if (isAvailable && !isExcluded) {
          paths.push({
            params: {
              slug: plugin.slug,
              country,
              platform
            }
          });
        }
      }
    }
  }
  
  return paths;
}

const { slug, country, platform } = Astro.params;
const plugin = plugins.find(p => p.slug === slug);

if (!plugin) {
  return Astro.redirect('/404');
}

// Cargar el contenido HTML del plugin
const contentPath = path.join(process.cwd(), 'src', 'content', 'plugins', `${slug}.html`);
let content = '';
let screenshots = plugin.screenshots ?? [];

try {
  content = fs.readFileSync(contentPath, 'utf-8');
} catch (error) {
  console.warn(`No se encontró el archivo de contenido para el plugin ${slug}`);
  content = '<p>Estamos trabajando en este contenido, por favor regresa más tarde.</p>';
}

// Meta tags para SEO
const metaDescription = `${plugin.short_description} - Plugin premium para ${platform === 'woocommerce' ? 'WooCommerce' : 'PrestaShop'} disponible en Cujiware.`;
const canonicalUrl = `https://cujiware.com/plugins/${country}/${platform}/${plugin.slug}`;
const ogImage = screenshots.length > 0 ? `https://cujiware.com${screenshots[0].src}` : undefined;

// Schema.org structured data
const schemaData = {
  "@context": "https://schema.org",
  "@type": "SoftwareApplication",
  "name": plugin.name,
  "description": plugin.short_description,
  "applicationCategory": plugin.category === 'payment_method' ? 'FinancialApplication' : 
                        plugin.category === 'shipping' ? 'LogisticsApplication' : 
                        'SoftwareApplication',
  "softwareRequirements": platform === 'woocommerce' ? 'WordPress' : 'PrestaShop',
  "operatingSystem": "Linux",
  "author": {
    "@type": "Organization",
    "name": "Cujiware"
  },
  "image": screenshots.length > 0 ? `https://cujiware.com${screenshots[0].src}` : undefined,
  "url": canonicalUrl,
  "screenshot": screenshots.map(screenshot => ({
    "@type": "ImageObject",
    "url": `https://cujiware.com${screenshot.src}`,
    "caption": screenshot.caption
  })),
  "offers": {
    "@type": "Offer",
    "priceSpecification": {
      "@type": "UnitPriceSpecification",
      "priceCurrency": "USD",
      "price": 12,
      "billingIncrement": 1,
      "billingDuration": 1,
      "unitCode": "MON",
      "unitText": "Mes",
      "description": "Membresía recurrente mensual"
    },
    "businessFunction": "http://purl.org/goodrelations/v1#LeaseOut",
    "url": "https://cujiware.com/suscripcion/"
  }
};
---

<Layout 
  title={`${plugin.name} - Cujiware`}
  description={metaDescription}
  canonicalURL={canonicalUrl}
  image={ogImage}
>
  <script type="application/ld+json" set:html={JSON.stringify(schemaData)} />
  <PluginDetail 
    client:load
    plugin={plugin}
    country={country}
    platform={platform}
    content={content}
    screenshots={screenshots}
  />
</Layout>