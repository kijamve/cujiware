---
import Layout from '@/layouts/Layout.astro';
import { requireSuperAdmin } from '@/middleware/auth.ts';
import { prisma } from '@/lib/prisma';
import plugins from '@/data/plugins.json';
import Tabs from '@/components/dashboard/Tabs.astro';
import PluginList from '@/components/dashboard/PluginList.astro';
import UploadModal from '@/components/dashboard/UploadModal.astro';

const user = await requireSuperAdmin(Astro);
if (user instanceof Response) {
  return user;
}

// Obtener todas las versiones de plugins
const pluginVersions = await prisma.pluginVersion.findMany({
  orderBy: {
    created_at: 'desc'
  }
});

// Agrupar versiones por plugin
const versionsByPlugin = pluginVersions.reduce((acc, version) => {
  if (!acc[version.plugin_slug]) {
    acc[version.plugin_slug] = [];
  }
  acc[version.plugin_slug].push(version);
  return acc;
}, {} as Record<string, typeof pluginVersions>);
---

<Layout title="Dashboard Master - Cujiware" description="Panel de administración de Cujiware">
  <div class="min-h-screen bg-gray-50 py-12">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="bg-white shadow rounded-lg">
        <div class="px-4 py-5 sm:p-6">
          <div class="flex justify-between items-center mb-8">
            <h1 class="text-2xl font-bold text-gray-900">Dashboard Master</h1>
            <button
              id="logout-btn"
              class="inline-flex items-center justify-center px-3 py-2 border border-gray-300 text-sm leading-4 font-medium rounded-md text-red-700 bg-white hover:bg-red-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500"
            >
              Cerrar Sesión
            </button>
          </div>

          <Tabs activeTab="plugins" />

          <!-- Contenido de Plugins -->
          <div id="plugins-content" class="mt-8">
            <div class="flex justify-between items-center mb-6">
              <h2 class="text-lg font-medium text-gray-900">Gestión de Plugins</h2>
              <button
                id="upload-plugin-btn"
                class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-cuji-blue hover:bg-cuji-dark-blue focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-cuji-blue"
              >
                Subir Nueva Versión
              </button>
            </div>

            <PluginList plugins={plugins} versionsByPlugin={versionsByPlugin} />
          </div>

          <!-- Contenido de Membresías (inicialmente oculto) -->
          <div id="memberships-content" class="mt-8 hidden">
            <!-- Aquí irá el contenido de membresías -->
          </div>
        </div>
      </div>
    </div>
  </div>
</Layout>

<UploadModal plugins={plugins} />

<script>
  // Logout
  const logoutBtn = document.getElementById('logout-btn');
  logoutBtn?.addEventListener('click', async () => {
    try {
      const response = await fetch('/api/admin/logout', {
        method: 'POST'
      });
      if (response.ok) {
        window.location.href = '/dashboard_master/login';
      }
    } catch (error) {
      console.error('Error al cerrar sesión:', error);
    }
  });
</script> 